<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz An To√†n B·∫£o M·∫≠t</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Quiz An To√†n B·∫£o M·∫≠t</h1>
            <p class="subtitle">D√†nh cho b·∫°n th√¢n mnc</p>
        </header>

        <div class="quiz-info">
            <div class="score-board">
                <span class="score">ƒêi·ªÉm: <strong id="score">0</strong></span>
                <span class="accuracy">‚úÖ ƒê√∫ng: <strong id="correctCount">0</strong>/<strong
                        id="answeredCount">0</strong></span>
                <span class="progress">C√¢u: <strong id="current">0</strong>/<strong id="total">10</strong></span>
            </div>
        </div>

        <main class="quiz-container" id="quiz">
            <div class="start-screen" id="startScreen">
                <div class="start-content">
                    <h2>Ch·ªçn ch·∫ø ƒë·ªô luy·ªán t·∫≠p</h2>
                    <p>T·ªïng s·ªë c√¢u h·ªèi c√≥ s·∫µn: <strong>{{ total_questions }}</strong></p>

                    <div class="mode-tabs">
                        <button class="tab-btn active" onclick="switchTab('practice')">üìö Luy·ªán t·∫≠p</button>
                        <button class="tab-btn" onclick="switchTab('random')">üé≤ Ng·∫´u nhi√™n</button>
                    </div>

                    <!-- Practice Mode -->
                    <div class="mode-content" id="practiceMode">
                        <h3>Ch·ªçn kho·∫£ng c√¢u h·ªèi:</h3>
                        <div class="range-options">
                            <button class="range-btn" onclick="startPractice(1, 50)">C√¢u 1 - 50</button>
                            <button class="range-btn" onclick="startPractice(51, 100)">C√¢u 51 - 100</button>
                            <button class="range-btn" onclick="startPractice(101, 150)">C√¢u 101 - 150</button>
                            <button class="range-btn" onclick="startPractice(151, 200)">C√¢u 151 - 200</button>
                            <button class="range-btn" onclick="startPractice(201, 250)">C√¢u 201 - 250</button>
                            <button class="range-btn" onclick="startPractice(251, 300)">C√¢u 251 - 300</button>
                        </div>
                    </div>

                    <!-- Random Mode -->
                    <div class="mode-content hidden" id="randomMode">
                        <h3>Ch·ªçn s·ªë c√¢u h·ªèi:</h3>
                        <div class="range-options">
                            <button class="range-btn" onclick="startRandom(10)">10 c√¢u</button>
                            <button class="range-btn" onclick="startRandom(20)">20 c√¢u</button>
                            <button class="range-btn" onclick="startRandom(50)">50 c√¢u</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="question-screen hidden" id="questionScreen">
                <div class="nav-buttons">
                    <button class="btn-nav" onclick="goHome()">üè† Trang ch·ªß</button>
                    <button class="btn-nav" id="prevBtn" onclick="prevQuestion()" disabled>‚Üê C√¢u tr∆∞·ªõc</button>
                </div>

                <div class="question-card">
                    <div class="question-header">
                        <span class="question-number" id="qNumber">C√¢u 1</span>
                        <span class="question-id" id="qId"></span>
                        <span class="question-type" id="qType"></span>
                    </div>
                    <h2 class="question-text" id="qText"></h2>

                    <!-- Quiz options -->
                    <div class="options" id="options"></div>

                    <!-- Flashcard answer -->
                    <div class="flashcard hidden" id="flashcard">
                        <button class="btn-reveal" id="revealBtn" onclick="revealAnswer()">üëÅÔ∏è Xem ƒë√°p √°n</button>
                        <div class="flashcard-answer hidden" id="flashcardAnswer"></div>
                    </div>
                </div>

                <div class="feedback hidden" id="feedback">
                    <p id="feedbackText"></p>
                    <div class="explanation" id="explanation"></div>
                </div>
                <button class="btn-next hidden" id="nextBtn" onclick="nextQuestion()">C√¢u ti·∫øp theo ‚Üí</button>
            </div>

            <div class="result-screen hidden" id="resultScreen">
                <div class="result-card">
                    <h2>üéâ Ho√†n th√†nh!</h2>
                    <div class="final-score">
                        <span id="finalScore">0</span>/<span id="finalTotal">10</span>
                    </div>
                    <p class="result-message" id="resultMessage"></p>
                    <button class="btn-restart" onclick="location.reload()">L√†m l·∫°i</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let questions = [];
        let currentIndex = 0;
        let score = 0;
        let answered = false;
        let quizCount = 0;
        let answeredCount = 0;

        function switchTab(mode) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.mode-content').forEach(content => content.classList.add('hidden'));

            if (mode === 'practice') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('practiceMode').classList.remove('hidden');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('randomMode').classList.remove('hidden');
            }
        }

        function goHome() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën quay v·ªÅ trang ch·ªß? Ti·∫øn ƒë·ªô s·∫Ω b·ªã m·∫•t.')) {
                location.reload();
            }
        }

        async function startPractice(start, end) {
            const response = await fetch(`/api/questions?start=${start}&end=${end}`);
            questions = await response.json();

            if (questions.length === 0) {
                alert(`Kh√¥ng c√≥ c√¢u h·ªèi trong kho·∫£ng ${start}-${end}`);
                return;
            }

            quizCount = questions.filter(q => q.type === 'quiz').length;
            document.getElementById('total').textContent = questions.length;
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('questionScreen').classList.remove('hidden');

            showQuestion();
        }

        async function startRandom(count) {
            const response = await fetch(`/api/questions?limit=${count}`);
            questions = await response.json();

            quizCount = questions.filter(q => q.type === 'quiz').length;
            document.getElementById('total').textContent = questions.length;
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('questionScreen').classList.remove('hidden');

            showQuestion();
        }

        function showQuestion() {
            answered = false;
            const q = questions[currentIndex];

            document.getElementById('current').textContent = currentIndex + 1;
            document.getElementById('qNumber').textContent = `C√¢u ${currentIndex + 1}`;
            document.getElementById('qId').textContent = `(#${q.id})`;
            document.getElementById('qText').textContent = q.question;

            // Update prev button
            document.getElementById('prevBtn').disabled = currentIndex === 0;

            // Hide feedback and next button
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('nextBtn').classList.add('hidden');

            const optionsDiv = document.getElementById('options');
            const flashcardDiv = document.getElementById('flashcard');
            const qTypeSpan = document.getElementById('qType');

            if (q.type === 'quiz') {
                // Quiz mode
                qTypeSpan.textContent = 'üìù Tr·∫Øc nghi·ªám';
                qTypeSpan.className = 'question-type quiz';
                optionsDiv.classList.remove('hidden');
                flashcardDiv.classList.add('hidden');

                optionsDiv.innerHTML = '';
                ['A', 'B', 'C', 'D'].forEach(letter => {
                    if (q.options[letter]) {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.innerHTML = `<span class="option-letter">${letter}</span><span class="option-text">${q.options[letter]}</span>`;
                        btn.onclick = () => selectAnswer(letter, btn);
                        optionsDiv.appendChild(btn);
                    }
                });
            } else {
                // Flashcard mode
                qTypeSpan.textContent = 'üìñ Flashcard';
                qTypeSpan.className = 'question-type flashcard';
                optionsDiv.classList.add('hidden');
                flashcardDiv.classList.remove('hidden');

                document.getElementById('revealBtn').classList.remove('hidden');
                document.getElementById('flashcardAnswer').classList.add('hidden');
                document.getElementById('flashcardAnswer').textContent = q.answer;
            }
        }

        function revealAnswer() {
            document.getElementById('revealBtn').classList.add('hidden');
            document.getElementById('flashcardAnswer').classList.remove('hidden');
            document.getElementById('nextBtn').classList.remove('hidden');
            answered = true;
        }

        async function selectAnswer(answer, btn) {
            if (answered) return;
            answered = true;

            const q = questions[currentIndex];
            const response = await fetch(`/api/check?question_id=${q.id}&answer=${answer}`, {
                method: 'POST'
            });
            const result = await response.json();

            document.querySelectorAll('.option-btn').forEach(b => {
                b.disabled = true;
                const letter = b.querySelector('.option-letter').textContent;
                if (letter === result.correct_answer) {
                    b.classList.add('correct');
                } else if (letter === answer && !result.correct) {
                    b.classList.add('wrong');
                }
            });

            const feedback = document.getElementById('feedback');
            const feedbackText = document.getElementById('feedbackText');
            const explanation = document.getElementById('explanation');

            if (result.correct) {
                score++;
                document.getElementById('score').textContent = score;
                feedbackText.textContent = '‚úÖ Ch√≠nh x√°c!';
                feedback.className = 'feedback correct';
            } else {
                feedbackText.textContent = `‚ùå Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√† ${result.correct_answer}`;
                feedback.className = 'feedback wrong';
            }

            // Update answered count
            answeredCount++;
            document.getElementById('correctCount').textContent = score;
            document.getElementById('answeredCount').textContent = answeredCount;

            // Show explanation
            if (result.explanation) {
                explanation.innerHTML = `<strong>üìñ Gi·∫£i th√≠ch:</strong> ${result.explanation}`;
            } else {
                explanation.textContent = '';
            }

            feedback.classList.remove('hidden');

            document.getElementById('nextBtn').classList.remove('hidden');
        }

        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                showQuestion();
            }
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < questions.length) {
                showQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('questionScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');

            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalTotal').textContent = quizCount;

            const percent = quizCount > 0 ? (score / quizCount) * 100 : 100;
            let message = '';
            if (percent >= 90) message = 'üåü Xu·∫•t s·∫Øc! B·∫°n l√† chuy√™n gia ATBM!';
            else if (percent >= 70) message = 'üëç T·ªët l·∫Øm! Ti·∫øp t·ª•c c·ªë g·∫Øng nh√©!';
            else if (percent >= 50) message = 'üí™ Kh√° ·ªïn! C·∫ßn √¥n t·∫≠p th√™m!';
            else message = 'üìö C·ªë g·∫Øng h·ªçc th√™m nh√©!';

            document.getElementById('resultMessage').textContent = message;
        }
    </script>
</body>

</html>